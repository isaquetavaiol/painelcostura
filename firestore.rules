/**
 * @fileoverview Firestore Security Rules for Atelier Insights.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has exclusive access
 * to their own data, preventing unauthorized access or modification.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, creating a clear hierarchy of ownership.
 * - /users/{userId}: User profile data.
 * - /users/{userId}/services/{serviceId}: Services offered by the user.
 * - /users/{userId}/projects/{projectId}: Projects managed by the user.
 * - /users/{userId}/clients/{clientId}: Clients of the user.
 *
 * Key Security Decisions:
 * - No user listing: Listing all users is explicitly denied.
 * - Path-based ownership: Authorization is determined by the Firestore path, ensuring
 *   that only the user with the matching userId can access the data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure access to user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @deny (create) User with ID 'user456' cannot create a profile with ID 'user123'.
     * @allow (get) User with ID 'user123' can read their own profile.
     * @deny (get) User with ID 'user456' cannot read the profile of user 'user123'.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @deny (update) User with ID 'user456' cannot update the profile of user 'user123'.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (delete) User with ID 'user456' cannot delete the profile of user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure access to user-owned services.
     * @path /users/{userId}/services/{serviceId}
     * @allow (create) User with ID 'user123' can create a service under their ID.
     * @deny (create) User with ID 'user456' cannot create a service under user 'user123'.
     * @allow (get) User with ID 'user123' can read a service under their ID.
     * @deny (get) User with ID 'user456' cannot read a service under user 'user123'.
     * @allow (update) User with ID 'user123' can update a service under their ID.
     * @deny (update) User with ID 'user456' cannot update a service under user 'user123'.
     * @allow (delete) User with ID 'user123' can delete a service under their ID.
     * @deny (delete) User with ID 'user456' cannot delete a service under user 'user123'.
     * @principle Enforces document ownership for all operations within the user's service collection.
     */
    match /users/{userId}/services/{serviceId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure access to user-owned projects.
     * @path /users/{userId}/projects/{projectId}
     * @allow (create) User with ID 'user123' can create a project under their ID.
     * @deny (create) User with ID 'user456' cannot create a project under user 'user123'.
     * @allow (get) User with ID 'user123' can read a project under their ID.
     * @deny (get) User with ID 'user456' cannot read a project under user 'user123'.
     * @allow (update) User with ID 'user123' can update a project under their ID.
     * @deny (update) User with ID 'user456' cannot update a project under user 'user123'.
     * @allow (delete) User with ID 'user123' can delete a project under their ID.
     * @deny (delete) User with ID 'user456' cannot delete a project under user 'user123'.
     * @principle Enforces document ownership for all operations within the user's project collection.
     */
    match /users/{userId}/projects/{projectId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secure access to user-owned clients.
     * @path /users/{userId}/clients/{clientId}
     * @allow (create) User with ID 'user123' can create a client under their ID.
     * @deny (create) User with ID 'user456' cannot create a client under user 'user123'.
     * @allow (get) User with ID 'user123' can read a client under their ID.
     * @deny (get) User with ID 'user456' cannot read a client under user 'user123'.
     * @allow (list) User with ID 'user123' can list all clients under their ID.
     * @deny (list) User with ID 'user456' cannot list clients under user 'user123'.
     * @allow (update) User with ID 'user123' can update a client under their ID.
     * @deny (update) User with ID 'user456' cannot update a client under user 'user123'.
     * @allow (delete) User with ID 'user123' can delete a client under their ID.
     * @deny (delete) User with ID 'user456' cannot delete a client under user 'user123'.
     * @principle Enforces document ownership for all operations within the user's client collection.
     */
    match /users/{userId}/clients/{clientId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
  }
}
